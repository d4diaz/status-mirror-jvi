name: Sync JSON to GitHub Pages

on:
  workflow_dispatch: {}           # manual run
  schedule:
    - cron: "*/30 * * * *"       # every 30 minutes; adjust as you like

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch JSON
        env:
          SOURCE_URL: ${{ vars.SOURCE_URL }}
        run: |
          set -euo pipefail
          mkdir -p docs
          # Fetch with: -L follow redirects, -s silent, -S show errors, -f fail on HTTP >=400
          # We also set a basic User-Agent and accept JSON to help Google endpoints.
          curl -LsfS \
            -H "Accept: application/json" \
            -H "User-Agent: GitHubActions-curl" \
            "$SOURCE_URL" -o docs/data.json

          # Optional: validate JSON (jq is pre-installed on ubuntu-latest)
          jq . docs/data.json > /dev/null

      - name: Commit if changed
        run: |
          set -e
          if git diff --quiet -- docs/data.json; then
            echo "No changes in docs/data.json"
            exit 0
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data.json
          git commit -m "chore: update data.json [skip ci]"
          git push

      - name: Show file size and head
        run: |
          wc -c docs/data.json
          head -c 300 docs/data.json || true
